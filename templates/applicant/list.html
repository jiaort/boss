{% extends "base/base.html" %}
{% load bootstrap_pagination %}
{% load web_tags %}

{% block title %}
  <title>Applicant</title>
{% endblock %}

{% block content %}
  <div class="page-header">
    <h1><span class="text-muted font-weight-light"><i class="page-header-icon ion-ios-keypad"></i>应聘信息 / </span>应聘列表
    </h1>
  </div>
  <div class="nav-tabs-custom">
    <ul class="nav nav-tabs nav-tabs-simple">
      <li class="all">
        <a href="{% url 'applicant_list' %}">全部状态&nbsp;&nbsp;
          <label style="color:gray;">{{ applicant_status_count.0 }}</label>
        </a>
      </li>
      <li class="new">
        <a href="{% url 'applicant_list' %}?status=0">待处理&nbsp;&nbsp;
          <label style="color:blue;">{{ applicant_status_count.1 }}</label>
        </a>
      </li>
      <li class="suitable">
        <a href="{% url 'applicant_list' %}?status=1">合适&nbsp;&nbsp;
          <label style="color:green;">{{ applicant_status_count.2 }}</label>
        </a>
      </li>
      <li class="inappropriate">
        <a href="{% url 'applicant_list' %}?status=2">不合适&nbsp;&nbsp;
          <label style="color:red;">{{ applicant_status_count.3 }}</label>
        </a>
      </li>
      <li class="tobe">
        <a href="{% url 'applicant_list' %}?status=3">待定&nbsp;&nbsp;
          <label style="color:orange;">{{ applicant_status_count.4 }}</label>
        </a>
      </li>
    </ul>
  </div>
  <br>
  <div class='box-header'>
    <form class="form-inline" action="">
      <div>
        <input name="name" class="form-control" placeholder="姓名" value="{{ form.cleaned_data.name }}">
        <input name="job_title" class="form-control" placeholder="职位名称" value="{{ form.cleaned_data.job_title }}">
        <select name="read" class="form-control read" data-allow-clear="true">
          <option value="">全部阅读状态</option>
          <option value=0 {% if form.cleaned_data.read == 0 %}selected{% endif %}>未读</option>
          <option value=1 {% if form.cleaned_data.read == 1 %}selected{% endif %}>已读</option>
        </select>
        <button type="submit" class="btn btn-primary">查询</button>&nbsp;&nbsp;共{{ total }}条记录
      </div>
    </form>
  </div>
  </br>

  <div class="table-light">
    <table class="table table-bordered">
      <thead>
      <th>姓名</th>
{#      <th>来源</th>#}
      <th>毕业院校</th>
{#      <th>现居住地</th>#}
      <th>学历</th>
      <th>现职位</th>
      <th>投递职位</th>
      <th>职位地点</th>
{#      <th>职位负责人</th>#}
{#      <th>关联人</th>#}
      <th>应聘时间</th>
      <th>附件</th>
      <th id='status_sort' class="{% if form.cleaned_data.status_order == 1 %}sorting_asc{% elif form.cleaned_data.status_order == 2 %}sorting_desc{% else %}sorting{% endif %}">状态</th>
      <th id='read_sort' class="{% if form.cleaned_data.read_order == 1 %}sorting_asc{% elif form.cleaned_data.read_order == 2 %}sorting_desc{% else %}sorting{% endif %}">阅读</th>
      <th>操作</th>
      </thead>
      <tbody>
      {% for item in applicant_list %}
        <tr class="odd gradeX">
          <td><a href="{% url 'applicant_detail' item.id %}">{{ item.name }}</a></td>
{#          <td>{{ item.source }}</td>#}
          <td>{{ item.school }}</td>
{#          <td>{{ item.live_place }}</td>#}
          <td>{{ item.education }}</td>
          <td>{{ item.position }}</td>
          <td>{{ item.job.job_title }}</td>
          <td>{{ item.work_place }}</td>
{#          <td>{{ item.owner_name | default:"马瑞阳" }}</td>#}
{#          <td>{{ item.relater | default:"马瑞阳" }}</td>#}
          <td><a data-toggle="tooltip" data-state="info" data-placement="bottom" title data-original-title="{{ item.created_time| date:"Y-m-d H:m" }}">{{ item.created_time| date:"Y-m-d" }}</a></td>
          <td>
            {% if item.file_applicant %}
              {% for file in item.file_applicant %}
              <a href="{{ MEDIA_URL }}{{ file }}" target="view_window" download="" data-toggle="tooltip" data-state="info" data-placement="bottom" title data-original-title="{{ file|file_name }}">{{ forloop.counter }}</a>
              {% endfor %}
            {% else %}无{% endif %}
          </td>
          <td><label class="label label-tag {% if item.status == '待处理' %}label-primary{% elif item.status == '合适' %}label-success{% elif item.status == '不合适' %}label-danger{% elif item.status == '待定' %}label-warning{% endif %}">{{ item.status }}</label></td>
          <td><label class="label label-tag {% if item.read %}label-success{% else %}label-danger{% endif %}">{% if item.read %}已读{% else %}未读{% endif %}</label></td>
          <td>
            <a onclick="change_status({{ item.id }}, 3)" class="btn btn-xs btn-warning btn-outline btn-rounded">待定</a>
{#            <a onclick="change_status({{ item.id }}, 0)" class="btn btn-xs btn-primary btn-outline btn-rounded">待处理</a>#}
            <a onclick="change_status({{ item.id }}, 1)" class="btn btn-xs btn-success btn-outline btn-rounded">合适</a>
            <a onclick="change_status({{ item.id }}, 2)" class="btn btn-xs btn-danger btn-outline btn-rounded">不合适</a>
            <a onclick="change_read({{ item.id }})" class="btn btn-xs {% if item.read %}btn-danger{% else %}btn-success{% endif %} btn-outline btn-3d">{% if item.read %}未读{% else %}已读{% endif %}</a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div>
      {% bootstrap_paginate applicant_list url_extra_args=params range=10 show_first_last="true" %}
    </div>
  </div>
{% endblock %}

{% block script %}
  <script>
    // -------------------------------------------------------------------------
    // Initialize DEMO sidebar

    $(function () {
      pxDemo.initializeDemoSidebar();

      $('#px-demo-sidebar').pxSidebar();
      pxDemo.initializeDemo();

      let status = getUrlParam("status");
      if(status == 0){
        $(".new").addClass("active");  // 待处理
      }else if(status == 1){
        $(".suitable").addClass("active");  // 合适
      }else if(status == 2){
        $(".inappropriate").addClass("active"); // 不合适
      }else if(status == 3){
        $(".tobe").addClass("active"); // 待定
      }else{
        $(".all").addClass("active"); // 全部状态
      }

    });
  </script>

  <script type="text/javascript">
    // -------------------------------------------------------------------------
    // Initialize DEMO

    $(function () {
      let file = String(document.location).split('/').pop();

      // Remove unnecessary file parts
      file = file.replace(/(\.html).*/i, '$1');

      if (!/.html$/i.test(file)) {
        file = 'index.html';
      }

      // Activate current nav item
      $('body > .px-nav')
        .find('.px-nav-item > a[href="' + file + '"]')
        .parent()
        .addClass('active');

      $('body > .px-nav').pxNav();
      $('body > .px-footer').pxFooter();

      $('#navbar-notifications').perfectScrollbar();
      $('#navbar-messages').perfectScrollbar();
    });

    $(function() {
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>

  <script>
    // -------------------------------------------------------------------------
    // Initialize DataTables

    $(function () {
      $('#status_sort').click(function () {
        if ($('#status_sort').attr('class') == 'sorting_asc') {
          $('#status_sort').attr('class', 'sorting_desc');
          window.location.href = setParam('status_order', 2);
        } else if ($('#status_sort').attr('class') == 'sorting_desc') {
          $('#status_sort').attr('class', 'sorting');
          window.location.href = setParam('status_order', 0);
        } else {
          $('#status_sort').attr('class', 'sorting_asc');
          window.location.href = setParam('status_order', 1);
        }
      });

      $('#read_sort').click(function () {
        if ($('#read_sort').attr('class') == 'sorting_asc') {
          $('#read_sort').attr('class', 'sorting_desc');
          window.location.href = setParam('read_order', 2);
        } else if ($('#read_sort').attr('class') == 'sorting_desc') {
          $('#read_sort').attr('class', 'sorting');
          window.location.href = setParam('read_order', 0);
        } else {
          $('#read_sort').attr('class', 'sorting_asc');
          window.location.href = setParam('read_order', 1);
        }
      });

      $('#datatables').dataTable();
      {#$('#datatables_wrapper .table-caption').text('职位信息');#}
      $('#datatables_wrapper .dataTables_filter input').attr('placeholder', 'Search...');
    });


    function change_status(applicant_id, status) {
      bootbox.confirm({
        message: '确定执行此操作?',
        className: 'bootbox-sm',

        callback: function (result) {
          if (result) {
            $.ajax({
              url: "{% url 'change_applicant_status' %}",
              type: "POST",
              data: {
              applicant_id: applicant_id,
              status: status,
              },
              success: function (data) {
                if (data.code == ERROR_CODE.SUCCESS) {
                  window.location.href = "{% url 'applicant_list' %}";
                } else if (data.code == ERROR_CODE.NOT_LOGIN) {
                  window.location.href = "{% url 'sso_login' %}";
                } else {
                  msg_info(data.msg_cn, 'danger');
                }
              }
            });
          }
        },
      });
    }

    function change_read(applicant_id) {
      $.ajax({
        url: "{% url 'change_applicant_read' %}",
        type: "POST",
        data: {
          applicant_id: applicant_id,
        },
        success: function (data) {
          if (data.code == ERROR_CODE.SUCCESS) {
            {#window.location.href = "{% url 'applicant_list' %}";#}
            location.reload();
          } else if (data.code == ERROR_CODE.NOT_LOGIN) {
            window.location.href = "{% url 'sso_login' %}";
          } else {
            msg_info(data.msg_cn, 'danger');
          }
        }
      });
    }
  </script>
{% endblock %}
